name: ci
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-lint-${{ hashFiles('requirements-dev.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-lint-
            ${{ runner.os }}-pip-

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install ruff black

      - name: Run Ruff linter
        run: python -m ruff check src/ tests/ --output-format=github
        continue-on-error: true

      - name: Check Black formatting
        run: python -m black --check --diff src/ tests/
        continue-on-error: true

  test:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements*.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Generate synthetic test fixtures
        run: python tests/fixtures/generate_synthetic.py

      - name: Run unit tests
        run: python -m pytest tests/test_temporal_safety.py tests/test_new_modules.py -v --tb=short

  pipeline:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements*.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Create output directories
        run: mkdir -p models features eval

      - name: Generate synthetic test fixtures
        run: python tests/fixtures/generate_synthetic.py

      - name: Generate features (synthetic)
        run: python src/features_processor.py

      - name: Train models (synthetic)
        run: python train_models.py

      - name: Calibrate models
        run: python src/calibration.py --features features/features_processed.csv
        continue-on-error: true

      - name: Integration tests
        run: python test_integration.py
        continue-on-error: true

      - name: Backtests (synthetic)
        run: make backtest-ci
        continue-on-error: true

      - name: Upload model artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: model-artifacts
          path: |
            models/*.pkl
            models/*.json
            models/training_metrics.json
          retention-days: 7

      - name: Upload evaluation artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: eval-artifacts
          path: |
            eval/*.csv
            features/features_processed.csv
          retention-days: 7
